<!DOCTYPE html>
<html>
<head>
    <title>Digital Rain</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            background: black;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-family: monospace;
        }

        .matrix-column {
            font-size: var(--font-size, 1.5em);
            display: flex;
            flex-direction: column;
            user-select: none;
            position: relative;
            will-change: transform;
        }

        .matrix-container {
            display: flex;
            justify-content: space-around;
            width: 100vw;
            height: 100vh;
            transform: scale(1.2);
            will-change: transform;
        }

        .character {
            position: absolute;
            text-shadow: 0 0 calc(8px * var(--glow-intensity)) var(--glow-color);
            opacity: var(--opacity);
            color: var(--char-color);
            will-change: transform;
            transform: translateY(var(--y-pos));
        }

        .leader {
            --char-color: #fff !important;
            text-shadow: 0 0 calc(12px * var(--glow-intensity)) var(--glow-color),
                        0 0 calc(20px * var(--glow-intensity)) var(--glow-color) !important;
            opacity: 1 !important;
        }

        .trail {
            --opacity: 0.8;
            text-shadow: 0 0 calc(8px * var(--glow-intensity)) var(--glow-color),
                        0 0 calc(15px * var(--glow-intensity)) var(--glow-color);
        }
    </style>
</head>
<body>
    <div class="matrix-container" id="container"></div>
    <script>
        const { ipcRenderer } = require('electron');
        
        console.log('Matrix script starting...');
        
        const container = document.getElementById('container');
        const chars = "日ﾊﾐﾋｰｳｼﾅﾓﾆｻﾜﾂｵﾘｱﾎﾃﾏｹﾒｴｶｷﾑﾕﾗｾﾈｽﾀﾇﾍ012345789:・.\"=*+-<>¦｜╌";
        
        // Default settings
        let settings = {
            speed: 1.0,
            color: '#00ff00',
            density: 1.0,
            fontSize: 20,
            glowIntensity: 1.0
        };

        // Animation state
        let animationFrameId;
        const columns = new Map();

        function updateCharacterPosition(char, speed) {
            const yPos = parseFloat(char.style.getPropertyValue('--y-pos')) || -100;
            const newPos = yPos + (0.5 * speed);
            
            if (newPos > window.innerHeight) {
                char.style.setProperty('--y-pos', '-100px');
                char.textContent = chars[Math.floor(Math.random() * chars.length)];
            } else {
                char.style.setProperty('--y-pos', `${newPos}px`);
            }
        }

        function animate() {
            columns.forEach(columnChars => {
                columnChars.forEach(char => {
                    updateCharacterPosition(char, settings.speed);
                });
            });
            animationFrameId = requestAnimationFrame(animate);
        }

        function updateStyles() {
            document.documentElement.style.setProperty('--font-size', `${settings.fontSize}px`);
            document.documentElement.style.setProperty('--glow-intensity', settings.glowIntensity);
            
            columns.forEach(columnChars => {
                columnChars.forEach(char => {
                    if (!char.classList.contains('leader')) {
                        char.style.setProperty('--char-color', settings.color);
                    }
                    char.style.setProperty('--glow-color', settings.color);
                });
            });
        }
        
        function createMatrix() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            container.innerHTML = '';
            columns.clear();
            
            const columnCount = Math.floor(window.innerWidth / (settings.fontSize * settings.density));
            
            for (let i = 0; i < columnCount; i++) {
                const column = document.createElement('div');
                column.className = 'matrix-column';
                const columnChars = new Set();
                
                const characterCount = Math.floor(Math.random() * 25 + 20);
                for (let j = 0; j < characterCount; j++) {
                    const char = document.createElement('div');
                    char.className = 'character';
                    char.textContent = chars[Math.floor(Math.random() * chars.length)];
                    
                    char.style.setProperty('--y-pos', `${Math.random() * -500}px`);
                    
                    if (j === 0) {
                        char.classList.add('leader');
                    } else {
                        char.classList.add('trail');
                        char.style.setProperty('--char-color', settings.color);
                    }
                    char.style.setProperty('--glow-color', settings.color);
                    
                    column.appendChild(char);
                    columnChars.add(char);
                }
                
                container.appendChild(column);
                columns.set(column, columnChars);
            }
            
            animate();
        }

        // Handle settings updates
        ipcRenderer.on('update-settings', (event, newSettings) => {
            const needsRecreate = newSettings.fontSize !== settings.fontSize || 
                                newSettings.density !== settings.density;
            
            settings = { ...settings, ...newSettings };
            
            if (needsRecreate) {
                setTimeout(createMatrix, 50);
            } else {
                updateStyles();
            }
        });

        // Initial creation
        createMatrix();

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(createMatrix, 100);
        });

        // Cleanup on unload
        window.addEventListener('unload', () => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    </script>
</body>
</html> 